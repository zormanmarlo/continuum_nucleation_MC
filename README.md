# Continuum Monte Carlo Model for Simulation of Nucleation

## Overview
This code enables simulation of speciation and nucleation in a continuous coordinate space. Interactions are calculated based on a user-supplied set of tabulated potentials, which should be placed in the potentials/ directory. Repulsive potentials are switched from the infinitely dilute form to a screened form as a function of cluster size when two like ions are within the clus_cutoff of the same unlike ion and within the counter_cutoff of each other. For now, screened potentials are hardcoded for the JC and Dang forcefields. YOU MUST set whether you are using Dange or JC by copying the specific _FF_system.py_ file to _system.py_. There is a much better way of doing this, it is on the todo list.
 
## Use example
Information for a simulation run is contained in the config file. 
- See _configs/commented_example.txt_ for a well-commented example.
- See _configs/25mM_nacl_config_adapUS_JC.txt_ for an example of an adaptive US config file.
- See _100mM_submit.sh_ for an example of how one might submit this script to a cluster.
- Run _python simulation.py -h_ for information on flags for the python script.

## Umbrella sampling example
Umbrella sampling along the nuclei size can be performed by running a set of biased simulations with increasing bias centers. See the directory _US_files_ for the following files:
- _run_us.sh_ is a basic US driver. It iterates over the range of cluster size centers and generates an edited config input and slurm submission file that it then submits and deletes.
- _submit_template.sh_ is the template slurm submission file that is edited by _run_us.sh_
- _configs/nacl_us/100mM_nacl_template_large_random_JC.txt_ is an example of a template submission script that is copied and edited by _run_us.sh_. Note that this one is set up for a 100 mM NaCl system with the JC forcefield. The two important pieces in this file are the bias center and the coordinate input path, both of which are edited for each window by _run_us.sh_
- _inputs/nacl_us/100mM_nacl_32mer_large_random_00.xyz_ is an example of window coordinate inputs.
- _gen_US_structs.py_ is a script to generate NaCl cluster inputs for US windows. For each input it generates a (randomly populated) cluster of size N, as well as randomly placed bath atoms. Note that the central cluster is generated by randomly growing a cluster of size N with neighbors from a lattice. Bath atoms are placed such that they are not in the central custer.

IMPORTANT NOTE: As of right now, I run five independent simulations for each US window. Whenever a job for a window is run, it launches five independent simulations. Each simulation needs it own input structure. that is why input xyz files have the _00_, _01_, etc at the end. In order to not have 5\*N_windows config files, we omit the ID in the template config files. When a simulation is launched and told to use an input file, it adds its ID to the end of the xyz file. There is certainly a better way of doing this.

So, in order to run an US simulation, do the following:
1. Generate input structures with _gen_US_structs.py_. This code is unoptimized and may take some time to run for higher concentrations. Edit the parameters within it to get the number of input structures per window you concentration you prefer.
2. Create a config template with the parameters you would like
3. Edit a _submit_template.sh_ to work for your cluster
4. Run _run_us.sh_ in the main directory
5. Once all windows are run, you can combine the colvar files from independent trajectories for each window with _clean_colvars.sh_. By default we delete the first half of each trajectory. 
6. Run WHAM on the resulting colvar files. 

## Adaptive US example
Adaptive US is as easy as running _simulation.py_ with the _-adaptive_ flag. Note that when you do this, all independent processes will run for the number of steps in the config file in each adaptive iteration before clustering data is collected and the bias is updated. 
